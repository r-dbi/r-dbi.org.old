<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Kirill Müller">
<meta name="dcterms.date" content="2021-01-20">
<meta name="description" content="Summarizing the progress of 2020">

<title>R-DBI - Maintaining DBI, 3/4</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">R-DBI</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../blog/index.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../backends/index.html" rel="" target="">
 <span class="menu-text">Backends</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#what-is-dbi" id="toc-what-is-dbi" class="nav-link active" data-scroll-target="#what-is-dbi">What is DBI?</a></li>
  <li><a href="#scope-of-the-dbi-project" id="toc-scope-of-the-dbi-project" class="nav-link" data-scroll-target="#scope-of-the-dbi-project">Scope of the DBI project</a></li>
  <li><a href="#recent-developments-in-dbi" id="toc-recent-developments-in-dbi" class="nav-link" data-scroll-target="#recent-developments-in-dbi">Recent developments in DBI</a>
  <ul class="collapse">
  <li><a href="#new-tutorials" id="toc-new-tutorials" class="nav-link" data-scroll-target="#new-tutorials">New tutorials</a></li>
  <li><a href="#time-zones" id="toc-time-zones" class="nav-link" data-scroll-target="#time-zones">Time zones</a></li>
  <li><a href="#notable-changes-to-dbi-backends" id="toc-notable-changes-to-dbi-backends" class="nav-link" data-scroll-target="#notable-changes-to-dbi-backends">Notable changes to DBI backends</a></li>
  <li><a href="#qa-and-automation" id="toc-qa-and-automation" class="nav-link" data-scroll-target="#qa-and-automation">QA and automation</a></li>
  </ul></li>
  <li><a href="#future-work" id="toc-future-work" class="nav-link" data-scroll-target="#future-work">Future work</a></li>
  <li><a href="#acknowledgments" id="toc-acknowledgments" class="nav-link" data-scroll-target="#acknowledgments">Acknowledgments</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Maintaining DBI, 3/4</h1>
</div>

<div>
  <div class="description">
    Summarizing the progress of 2020
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Kirill Müller </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 20, 2021</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="what-is-dbi" class="level2">
<h2 class="anchored" data-anchor-id="what-is-dbi">What is DBI?</h2>
<p>DBI stands for <strong>d</strong>ata<strong>b</strong>ase <strong>i</strong>nterface. The DBI package connects R to database management systems (DBMS). The goal of DBI is to provide a common interface for database access, regardless of the specific underlying DBMS. DBI works with a variety of DBMS, such as Postgres, MariaDB, and SQLite, through dedicated <a href="https://github.com/r-dbi/backends#readme">backend packages</a>. For first-time users I recommend starting with the new <a href="https://dbi.r-dbi.org/articles/dbi">introductory tutorial</a>.</p>
<p>The current version of DBI is 1.1.1. This blog post attempts to define the scope of the DBI project, summarizes recent developments in DBI and related packages, and showcases future work.</p>
</section>
<section id="scope-of-the-dbi-project" class="level2">
<h2 class="anchored" data-anchor-id="scope-of-the-dbi-project">Scope of the DBI project</h2>
<p>The DBI package is perfect for anyone looking to connect to a database, read/write entire tables, and/or execute SQL queries. DBI gives a direct access to the database driver, leaving more sophisticated data query and manipulation tasks to packages like <a href="https://dbplyr.tidyverse.org/">dbplyr</a>, <a href="https://github.com/ankane/dbx">dbx</a> and <a href="https://winvector.github.io/rquery/">rquery</a>.</p>
<p>The core DBI project in R provides an interface for databases, specified in textual form and via automated tests. The <a href="https://dbi.r-dbi.org/articles/spec">DBI specification</a> contains a detailed description of the methods provided by DBI. In summary, the interface covers:</p>
<ul>
<li><p>Discovery of tables, also in schemas</p></li>
<li><p>Reading/writing/creating/removing tables</p></li>
<li><p>Executing queries, fetching data (with parameters)</p></li>
<li><p>Safe quoting: low-level composition of queries</p></li>
<li><p>Transactions</p></li>
</ul>
<p>DBI should provide a way to ingest data of any type into R, at least in serialized form (e.g.&nbsp;string or <a href="https://en.wikipedia.org/wiki/Binary_large_object">blob</a>). It should offer a robust reliable interface for dependent packages; anything beyond this scope should be left to packages that extend DBI:</p>
<ul>
<li><p>arkdb: archival of database data</p></li>
<li><p>connection: integrate database connections with the RStudio IDE</p></li>
<li><p>dbplyr and rquery: generation of SQL queries</p></li>
<li><p>dbx: DBI extension for data manipulation</p></li>
<li><p>dittodb: mocking for databases</p></li>
<li><p>dm: relational data models (via dbplyr)</p></li>
<li><p>pool: connection pooling</p></li>
<li><p>sqlr: schema definition</p></li>
</ul>
<p>and many more.</p>
</section>
<section id="recent-developments-in-dbi" class="level2">
<h2 class="anchored" data-anchor-id="recent-developments-in-dbi">Recent developments in DBI</h2>
<p>This section discusses:</p>
<ul>
<li><p>the new DBI tutorials,</p></li>
<li><p>improvements for datetime data,</p></li>
<li><p>other notable changes,</p></li>
<li><p>the move to GitHub Actions.</p></li>
</ul>
<p>The first three items directly affect DBI users, the last item much less so. It is nevertheless an important investment in the stability of the DBI infrastructure.</p>
<section id="new-tutorials" class="level3">
<h3 class="anchored" data-anchor-id="new-tutorials">New tutorials</h3>
<p>James Wondrasek substantially expanded the “Introduction to DBI” article and added a second article. DBI now features two tutorials. The <a href="https://dbi.r-dbi.org/articles/dbi">introduction</a> includes a walkthrough that describes connecting and querying a real database. The <a href="https://dbi.r-dbi.org/articles/dbi-advanced">“Advanced DBI usage”</a> tutorial shows more advanced examples of quoting and parameter binding. The tutorials are an important first-hand resource for new users.</p>
</section>
<section id="time-zones" class="level3">
<h3 class="anchored" data-anchor-id="time-zones">Time zones</h3>
<p>To date, it was only possible to work reliably with time zones when the database connection represented all times in UTC. This poses a few problems in practice:</p>
<ul>
<li><p>Not all databases store timestamps as UTC or with time zone offset, often local time is assumed by the data model.</p></li>
<li><p>Other systems often use the default setting for time zone, this harms interoperability of DBI in these cases.</p></li>
<li><p>Conversion of timestamps to dates via the SQL function <code>DATE</code> is only correct when the session time zone is set correctly.</p></li>
</ul>
<p>RMariaDB 1.1.0 and RPostgres 1.3.0 gained more robust support for datetime values. As proposed in the <a href="https://www.r-dbi.org/blog/dbi-3-2/">previous blog post</a>, new arguments <code>timezone</code> and <code>timezone_out</code> were added. Both arguments should use Olson names such as <code>Europe/Berlin</code> or <code>America/New_York</code>, not time offsets like <code>+01:00</code>; the latter may change with daylight time savings season. If <code>timezone</code> is set to <code>NULL</code>, an attempt is made to detect the correct time zone on the database. Thanks to Philipp Schauberger for contributing the initial <code>timezone</code> argument for RMariaDB.</p>
<p>RSQLite does not natively support dates or times. A promising <a href="https://github.com/r-dbi/RSQLite/pull/333">pull request</a> is underway that implements support for treating numeric values as time offsets if the column type is declared in a specific way.</p>
</section>
<section id="notable-changes-to-dbi-backends" class="level3">
<h3 class="anchored" data-anchor-id="notable-changes-to-dbi-backends">Notable changes to DBI backends</h3>
<p>The following package versions were sent to CRAN since the last blog post:</p>
<ul>
<li>DBI 1.1.0 -&gt; 1.1.1 (<a href="https://dbi.r-dbi.org/news/">NEWS</a>)</li>
<li>RMariaDB 1.0.8 -&gt; 1.1.0 (<a href="https://rmariadb.r-dbi.org/news/">NEWS</a>)</li>
<li>RPostgres 1.2.0 -&gt; 1.3.1 (<a href="https://rpostgres.r-dbi.org/news/">NEWS</a>)</li>
<li>RSQLite 2.1.5 -&gt; 2.2.2 (<a href="https://rsqlite.r-dbi.org/news/">NEWS</a>)</li>
</ul>
<p>Highlights are:</p>
<ul>
<li><p>DBI: Two new tutorials; minor improvements to <code>dbQuoteLiteral()</code>, this is relevant for backends that don’t provide their own implementation.</p></li>
<li><p>RMariaDB: Better handling of data types and character encoding; minor tweaks to <code>dbBind()</code> and <code>dbQuoteLiteral()</code>.</p></li>
<li><p>RPostgres: The new <code>Redshift()</code> driver that allows downstream packages to distinguish between Postgres and Amazon RedShift (thanks Hadley Wickham); minor improvements for querying and passing date and time types, <code>postgresWaitForNotify()</code> contributed by Jamie Lentin.</p></li>
<li><p>RSQLite: <code>dbAppendTable()</code> is faster, strings and blobs can have virtually unlimited size (limit 2 GB), embedded SQLite library is now in version 3.34.</p></li>
<li><p>DBItest: understanding which tests failed is now simpler, also thanks to simpler backtraces; <code>test_some()</code> integrates with the dblog package and shows DBI methods called; established compatibility with testthat 3.0.0; better and more robust tests.</p></li>
<li><p>RKazam: Is now a template repository</p></li>
</ul>
<p>Thanks to Jeroen Ooms for maintaining Windows versions for the database libraries.</p>
</section>
<section id="qa-and-automation" class="level3">
<h3 class="anchored" data-anchor-id="qa-and-automation">QA and automation</h3>
<p>Automated tests are a crucial part of modern software engineering. These are often augmented with continuous integration (CI) services that run these tests regularly or with every change to the code. When I started working on DBI, Travis CI offered excellent continuous integration services for open-source repositories. Unfortunately, this is no longer the case: the free tier introduced a limit on CI build time, rendering it effectively unusable for DBI.</p>
<p><a href="https://github.com/features/actions">GitHub Actions</a> is a CI/CD platform tightly integrated with GitHub. It is somewhat simpler to set up, also for creating workflows that e.g.&nbsp;open a pull request. It is sufficient to add a YAML configuration file to a dedicated location in the repository. Each build automatically obtains a token that can be used to interact with the GitHub API. R support is provided by <a href="https://github.com/r-lib/actions">dedicated workflows and actions</a> contributed by RStudio. Check status is conveniently reported in detail with each pull request, and the checks run considerably faster due to higher concurrency.</p>
<p>Continuous integration for all packages in the project has moved to GitHub Actions. Cross-platform checks for all backends on the major operating systems were a bit challenging, because the tests require a live database. Thanks to Andrew Kane for providing GitHub actions that install database engines on all platforms, this greatly simplified the move.</p>
<p>Three more parts of the infrastructure were updated as part of the move:</p>
<ol type="1">
<li><p>The odbc and duckdb packages are now also checked when the DBItest package updates. This ensures that new or amended specifications do not break these packages. If you maintain a DBI backend that uses DBItest, get in touch for integrating your backend with these checks.</p></li>
<li><p>The <a href="https://github.com/r-dbi/backends#readme">list of DBI backends</a> is now continuously updated. Updates to backends are applied automatically. Every time a new backend is found, a pull request is opened.</p></li>
<li><p>A new <a href="https://github.com/r-dbi/RSQLite/pull/337">pull request</a> is opened in RSQLite when a new version of the SQLite library is available. This makes it much easier to keep the bundled SQLite version up to date.</p></li>
</ol>
</section>
</section>
<section id="future-work" class="level2">
<h2 class="anchored" data-anchor-id="future-work">Future work</h2>
<p>The last blog post already identified major milestones:</p>
<ul>
<li><p>query cancellation</p></li>
<li><p>testing on remote databases</p></li>
</ul>
<p>A triage of the contributed issues has identified the following additional major topics:</p>
<ul>
<li><p><code>immediate</code> argument to <code>dbSendQuery()</code> and <code>dbSendStatement()</code> for RMariaDB and RPostgres</p></li>
<li><p>performance of table import</p></li>
<li><p>reconnect if a database connection is lost</p></li>
</ul>
<p>Other minor issues include:</p>
<ul>
<li><p>SSL connections</p></li>
<li><p>authentication plugins</p></li>
<li><p>support for more data types: arrays, JSON, …</p></li>
</ul>
<p>I’m planning to resolve most of the remaining issues in a final sprint. Some of these issues can be outsourced to other packages, according to the scope outlined in the previous sections, priority should be given to issues that must be resolved in the core packages. Future work might shift towards providing or improving useful extensions.</p>
</section>
<section id="acknowledgments" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgments">Acknowledgments</h2>
<p>I’d like to thank James Wondrasek for creating the DBI tutorials and for a review of this blog post, Angelica Becerra for reviewing the material, and the numerous contributors to the packages in the “Maintaining DBI” project (DBI¹, RSQLite², RPostgres³, RMariaDB⁴, and DBItest⁵):</p>
<p><a href="https://github.com/abalter">@abalter</a>³, <a href="https://github.com/alanpaulkwan">@alanpaulkwan</a>², <a href="https://github.com/AllenSuttonValocity">@AllenSuttonValocity</a>³, <a href="https://github.com/altay-oz">@altay-oz</a>³, <a href="https://github.com/anderic1">@anderic1</a>², <a href="https://github.com/andybeet">@andybeet</a>¹, <a href="https://github.com/arencambre">@arencambre</a>⁴, <a href="https://github.com/artemklevtsov">@artemklevtsov</a>³, <a href="https://github.com/bastianilso">@bastianilso</a>⁴, <a href="https://github.com/bczernecki">@bczernecki</a>¹, <a href="https://github.com/Byggvir">@Byggvir</a>⁴, <a href="https://github.com/Chrisjb">@Chrisjb</a>¹, <a href="https://github.com/clementbfeyt">@clementbfeyt</a>⁴, <a href="https://github.com/colearendt">@colearendt</a>¹, <a href="https://github.com/daattali">@daattali</a>¹, <a href="https://github.com/datawookie">@datawookie</a>¹, <a href="https://github.com/dpprdan">@dpprdan</a>³⁵, <a href="https://github.com/elfatherbrown">@elfatherbrown</a>⁴, <a href="https://github.com/EntwicklR">@EntwicklR</a>², <a href="https://github.com/ericemc3">@ericemc3</a>⁴, <a href="https://github.com/formix">@formix</a>³, <a href="https://github.com/fproske">@fproske</a>¹, <a href="https://github.com/georgevbsantiago">@georgevbsantiago</a>¹, <a href="https://github.com/GitHunter0">@GitHunter0</a>¹, <a href="https://github.com/hadley">@hadley</a>²³, <a href="https://github.com/hmeleiro">@hmeleiro</a>¹, <a href="https://github.com/hpages">@hpages</a>², <a href="https://github.com/imlijunda">@imlijunda</a>³, <a href="https://github.com/inferiorhumanorgans">@inferiorhumanorgans</a>³, <a href="https://github.com/jarauh">@jarauh</a>⁴, <a href="https://github.com/jawond">@jawond</a>¹, <a href="https://github.com/jeroen">@jeroen</a>³, <a href="https://github.com/jimhester">@jimhester</a>¹, <a href="https://github.com/jjesusfilho">@jjesusfilho</a>³, <a href="https://github.com/jsilve24">@jsilve24</a>², <a href="https://github.com/kforner">@kforner</a>⁴, <a href="https://github.com/kmishra9">@kmishra9</a>², <a href="https://github.com/Kodiologist">@Kodiologist</a>¹², <a href="https://github.com/LaugeGregers">@LaugeGregers</a>³, <a href="https://github.com/luispuerto">@luispuerto</a>², <a href="https://github.com/martinstuder">@martinstuder</a>⁵, <a href="https://github.com/matteodelucchi">@matteodelucchi</a>⁴, <a href="https://github.com/MaximumV">@MaximumV</a>¹, <a href="https://github.com/mbannert">@mbannert</a>³, <a href="https://github.com/mbedward">@mbedward</a>³, <a href="https://github.com/mgirlich">@mgirlich</a>², <a href="https://github.com/mlamias">@mlamias</a>¹, <a href="https://github.com/mllg">@mllg</a>¹, <a href="https://github.com/mmuurr">@mmuurr</a>³, <a href="https://github.com/momeara">@momeara</a>³, <a href="https://github.com/MonteShaffer">@MonteShaffer</a>⁴, <a href="https://github.com/Mosk915">@Mosk915</a>⁴, <a href="https://github.com/nfultz">@nfultz</a>², <a href="https://github.com/norquanttech">@norquanttech</a>³, <a href="https://github.com/OMalytics">@OMalytics</a>³, <a href="https://github.com/oriolcmp">@oriolcmp</a>⁴, <a href="https://github.com/Osc2wall">@Osc2wall</a>⁴, <a href="https://github.com/psychobas">@psychobas</a>², <a href="https://github.com/randyzwitch">@randyzwitch</a>⁵, <a href="https://github.com/rcfree">@rcfree</a>², <a href="https://github.com/rnorberg">@rnorberg</a>¹, <a href="https://github.com/rodriguesk">@rodriguesk</a>², <a href="https://github.com/rossholmberg">@rossholmberg</a>⁴, <a href="https://github.com/Sahil308">@Sahil308</a>⁴, <a href="https://github.com/samuel-cs4">@samuel-cs4</a>⁴, <a href="https://github.com/schuemie">@schuemie</a>², <a href="https://github.com/shutinet">@shutinet</a>², <a href="https://github.com/splaisan">@splaisan</a>², <a href="https://github.com/Trowic">@Trowic</a>⁴, <a href="https://github.com/verajosemanuel">@verajosemanuel</a>⁴, <a href="https://github.com/VictorYammouni">@VictorYammouni</a>¹, <a href="https://github.com/vigyoyo">@vigyoyo</a>⁴, <a href="https://github.com/vikram-rawat">@vikram-rawat</a>³, <a href="https://github.com/vspinu">@vspinu</a>³, <a href="https://github.com/warnes">@warnes</a>³, <a href="https://github.com/wiligl">@wiligl</a>², <a href="https://github.com/ycphs">@ycphs</a>⁴, and <a href="https://github.com/zyxdef">@zyxdef</a>¹.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 © Licence MIT.
  </li>  
</ul>
    </div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
    <a class="nav-link" href="https://www.r-consortium.org/">Sponsored by the R Consortium.</a>
  </li>  
</ul>
    </div>
  </div>
</footer>



</body></html>